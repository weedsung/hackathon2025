const ReplyGuide = require('../models/ReplyGuide');
const History = require('../models/History');
const User = require('../models/User');

// í…œí”Œë¦¿ ë²„ì „ ê´€ë¦¬
const TEMPLATE_VERSION = '1.0.0';

const initializeReplyGuides = async () => {
  try {
    // ê¸°ì¡´ ë°ì´í„° í™•ì¸
    const existingCount = await ReplyGuide.countDocuments();
    
    if (existingCount > 0) {
      // ë²„ì „ í™•ì¸ì„ ìœ„í•œ ë©”íƒ€ë°ì´í„° ì²´í¬
      const versionDoc = await ReplyGuide.findOne({ isMetadata: true });
      
      if (versionDoc && versionDoc.templateVersion === TEMPLATE_VERSION) {
        return;
      } else {
        console.log('ğŸ”„ ReplyGuide ë°ì´í„° ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ë©”íƒ€ë°ì´í„° ì œì™¸)
        await ReplyGuide.deleteMany({ isMetadata: { $ne: true } });
      }
    }

    // ì´ˆê¸° í…œí”Œë¦¿ ë°ì´í„°
    const initialTemplates = [
      {
        category: 'apology',
        title: 'ëŠ¦ì€ ì‘ë‹µ ì‚¬ê³¼',
        situation: 'ì´ë©”ì¼ ë‹µì¥ì´ ëŠ¦ì—ˆì„ ë•Œ',
        content: 'ì•ˆë…•í•˜ì„¸ìš”.\n\nëŠ¦ì€ ë‹µë³€ìœ¼ë¡œ ì¸í•´ ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤.\n[êµ¬ì²´ì ì¸ ì‚¬ìœ ]ë¡œ ì¸í•´ ë‹µë³€ì´ ì§€ì—°ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní–¥í›„ ì´ëŸ° ì¼ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë”ìš± ì£¼ì˜í•˜ê² ìŠµë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.'
      },
      {
        category: 'request',
        title: 'ì •ì¤‘í•œ ìë£Œ ìš”ì²­',
        situation: 'ë™ë£Œë‚˜ ê±°ë˜ì²˜ì— ìë£Œë¥¼ ìš”ì²­í•  ë•Œ',
        content: 'ì•ˆë…•í•˜ì„¸ìš”.\n\n[í”„ë¡œì íŠ¸ëª…] ê´€ë ¨í•˜ì—¬ ì—°ë½ë“œë¦½ë‹ˆë‹¤.\n\n[êµ¬ì²´ì ì¸ ìë£Œëª…]ì— ëŒ€í•œ ìë£Œë¥¼ ìš”ì²­ë“œë¦¬ê³  ì‹¶ìŠµë‹ˆë‹¤.\nê°€ëŠ¥í•˜ì‹œë©´ [ë‚ ì§œ]ê¹Œì§€ ê³µìœ í•´ ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.\n\në°”ì˜ì‹  ì¤‘ì—ë„ í˜‘ì¡°í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.'
      },
      {
        category: 'response',
        title: 'ê¸ì •ì  í”¼ë“œë°± ì‘ë‹µ',
        situation: 'ì¹­ì°¬ì´ë‚˜ ê¸ì •ì  í”¼ë“œë°±ì„ ë°›ì•˜ì„ ë•Œ',
        content: 'ì•ˆë…•í•˜ì„¸ìš”.\n\nì†Œì¤‘í•œ í”¼ë“œë°±ì„ ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬í•©ë‹ˆë‹¤.\n\nì•ìœ¼ë¡œë„ ë” ë‚˜ì€ ê²°ê³¼ë¥¼ ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤.\nê³„ì†í•´ì„œ ì¢‹ì€ í˜‘ë ¥ ê´€ê³„ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆê¸°ë¥¼ ë°”ëë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.'
      },
      {
        category: 'meeting',
        title: 'íšŒì˜ ì¼ì • ì¡°ìœ¨',
        situation: 'íšŒì˜ ì¼ì •ì„ ì¡°ìœ¨í•´ì•¼ í•  ë•Œ',
        content: 'ì•ˆë…•í•˜ì„¸ìš”.\n\n[íšŒì˜ ì£¼ì œ] ê´€ë ¨ íšŒì˜ ì¼ì •ì„ ì¡°ìœ¨í•˜ê³ ì í•©ë‹ˆë‹¤.\n\nì œì•ˆ ê°€ëŠ¥í•œ ì‹œê°„:\n- [ë‚ ì§œ ì‹œê°„]\n- [ë‚ ì§œ ì‹œê°„]\n- [ë‚ ì§œ ì‹œê°„]\n\nì°¸ì„í•˜ì‹œê¸° í¸í•œ ì‹œê°„ì„ ì•Œë ¤ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.'
      },
      {
        category: 'request',
        title: 'ì—…ë¬´ í˜‘ì¡° ìš”ì²­',
        situation: 'ë™ë£Œì—ê²Œ ì—…ë¬´ ë„ì›€ì„ ìš”ì²­í•  ë•Œ',
        content: 'ì•ˆë…•í•˜ì„¸ìš”.\n\n[ì—…ë¬´ëª…] ì§„í–‰ ì¤‘ ë„ì›€ì´ í•„ìš”í•˜ì—¬ ì—°ë½ë“œë¦½ë‹ˆë‹¤.\n\n[êµ¬ì²´ì ì¸ ë„ì›€ ë‚´ìš©]ì— ëŒ€í•´ ì¡°ì–¸ì„ êµ¬í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.\nì‹œê°„ì´ ë˜ì‹¤ ë•Œ ì ê¹ ì´ì•¼ê¸°í•  ìˆ˜ ìˆì„ê¹Œìš”?\n\në°”ì˜ì‹  ì¤‘ì— ë²ˆê±°ë¡­ê²Œ í•´ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤.\nê°ì‚¬í•©ë‹ˆë‹¤.'
      },
      {
        category: 'apology',
        title: 'ì‹¤ìˆ˜ ì‚¬ê³¼',
        situation: 'ì—…ë¬´ìƒ ì‹¤ìˆ˜ë¥¼ í–ˆì„ ë•Œ',
        content: 'ì•ˆë…•í•˜ì„¸ìš”.\n\n[êµ¬ì²´ì ì¸ ì‹¤ìˆ˜ ë‚´ìš©]ì— ëŒ€í•´ ì§„ì‹¬ìœ¼ë¡œ ì‚¬ê³¼ë“œë¦½ë‹ˆë‹¤.\n\nì´ë²ˆ ì¼ë¡œ ì¸í•´ ë¶ˆí¸ì„ ë“œë¦° ì  ê¹Šì´ ì‚¬ê³¼ë“œë¦½ë‹ˆë‹¤.\nì•ìœ¼ë¡œëŠ” ì´ëŸ° ì¼ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë”ìš± ì‹ ì¤‘í•˜ê²Œ ì—…ë¬´ë¥¼ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.'
      },
      {
        category: 'meeting',
        title: 'íšŒì˜ë¡ ê³µìœ ',
        situation: 'íšŒì˜ í›„ íšŒì˜ë¡ì„ ê³µìœ í•  ë•Œ',
        content: 'ì•ˆë…•í•˜ì„¸ìš”.\n\n[ë‚ ì§œ]ì— ì§„í–‰ëœ [íšŒì˜ëª…] íšŒì˜ë¡ì„ ê³µìœ ë“œë¦½ë‹ˆë‹¤.\n\nì£¼ìš” ë…¼ì˜ ì‚¬í•­:\nâ€¢ [ë‚´ìš© 1]\nâ€¢ [ë‚´ìš© 2]\nâ€¢ [ë‚´ìš© 3]\n\nê²°ì • ì‚¬í•­:\nâ€¢ [ê²°ì • 1]\nâ€¢ [ê²°ì • 2]\n\nì¶”ê°€ ë…¼ì˜ê°€ í•„ìš”í•œ ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”.\n\nê°ì‚¬í•©ë‹ˆë‹¤.'
      },
      {
        category: 'response',
        title: 'ë¶€ì •ì  í”¼ë“œë°± ì‘ë‹µ',
        situation: 'ë¹„íŒì´ë‚˜ ë¶€ì •ì  í”¼ë“œë°±ì„ ë°›ì•˜ì„ ë•Œ',
        content: 'ì•ˆë…•í•˜ì„¸ìš”.\n\nì†Œì¤‘í•œ í”¼ë“œë°±ì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n\në§ì”€í•´ ì£¼ì‹  ë‚´ìš©ì„ ì§„ì§€í•˜ê²Œ ê²€í† í•˜ê³  ê°œì„ í•˜ê² ìŠµë‹ˆë‹¤.\nì•ìœ¼ë¡œëŠ” ë” ë‚˜ì€ ê²°ê³¼ë¥¼ ìœ„í•´ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤.\n\nì§€ì†ì ì¸ ê´€ì‹¬ê³¼ ì§€ë„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.'
      }
    ];

    // í…œí”Œë¦¿ ë°ì´í„° ì‚½ì…
    await ReplyGuide.insertMany(initialTemplates);
    
    // ë²„ì „ ë©”íƒ€ë°ì´í„° ì €ì¥/ì—…ë°ì´íŠ¸
    await ReplyGuide.findOneAndUpdate(
      { isMetadata: true },
      { 
        isMetadata: true,
        templateVersion: TEMPLATE_VERSION,
        lastUpdated: new Date()
      },
      { upsert: true }
    );
    
    console.log('âœ… ReplyGuide ì´ˆê¸° ë°ì´í„° ì‚½ì…/ì—…ë°ì´íŠ¸ ì™„ë£Œ (ë²„ì „: ' + TEMPLATE_VERSION + ')');
  } catch (error) {
    console.error('âŒ ReplyGuide ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  }
};

const initializeHistory = async () => {
  try {
    // ê¸°ì¡´ ë°ì´í„° í™•ì¸
    const existingCount = await History.countDocuments();
    
    if (existingCount > 0) {
      return;
    }

    // í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ì°¾ê¸° (ì—†ìœ¼ë©´ ìƒì„±)
    let testUser = await User.findOne({ email: 'test@example.com' });
    if (!testUser) {
      testUser = new User({
        email: 'test@example.com',
        password: 'test123',
        name: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì'
      });
      await testUser.save();
    }

    // ì´ˆê¸° íˆìŠ¤í† ë¦¬ ë°ì´í„°
    const initialHistory = [
      {
        user: testUser._id,
        type: 'review',
        title: 'í”„ë¡œì íŠ¸ ì¼ì • ì—°ê¸° ìš”ì²­ ë©”ì¼',
        content: 'ì•ˆë…•í•˜ì„¸ìš”. í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ì˜ ì¼ì • ì¡°ì •ì´ í•„ìš”í•˜ì—¬ ì—°ë½ë“œë¦½ë‹ˆë‹¤. ì˜ˆìƒë³´ë‹¤ ë³µì¡í•œ ìš”êµ¬ì‚¬í•­ì´ ì¶”ê°€ë˜ì–´ ì›ë˜ ê³„íšëœ ì¼ì •ì„ ì§€í‚¤ê¸° ì–´ë ¤ìš´ ìƒí™©ì…ë‹ˆë‹¤. ê°€ëŠ¥í•˜ì‹œë©´ ì¼ì •ì„ 1ì£¼ì¼ ì •ë„ ì—°ê¸°í•´ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”?',
        recipient: 'ê¹€íŒ€ì¥ë‹˜',
        date: new Date('2024-01-15T14:30:00'),
        score: 92,
        status: 'sent'
      },
      {
        user: testUser._id,
        type: 'manual',
        title: 'íšŒì˜ ì¼ì • ì¡°ìœ¨ ë©”ì¼',
        content: 'ì•ˆë…•í•˜ì„¸ìš”. ë‹¤ìŒ ì£¼ íŒ€ íšŒì˜ ì¼ì •ì„ ì¡°ìœ¨í•˜ê³ ì í•©ë‹ˆë‹¤. ì›”ìš”ì¼ ì˜¤í›„ 2ì‹œ, í™”ìš”ì¼ ì˜¤ì „ 10ì‹œ, ìˆ˜ìš”ì¼ ì˜¤í›„ 4ì‹œ ì¤‘ì—ì„œ ì°¸ì„ ê°€ëŠ¥í•œ ì‹œê°„ì„ ì•Œë ¤ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.',
        recipient: 'ê°œë°œíŒ€ ì „ì²´',
        date: new Date('2024-01-14T11:15:00'),
        template: 'íšŒì˜ ì¼ì • ì¡°ìœ¨',
        status: 'sent'
      },
      {
        user: testUser._id,
        type: 'review',
        title: 'ê¸‰íˆ í™•ì¸ ìš”ì²­ ë©”ì¼',
        content: 'ê¸‰íˆ í™•ì¸í•´ì£¼ì„¸ìš”. í”„ë¡œì íŠ¸ ê´€ë ¨ ì¤‘ìš”í•œ ì´ìŠˆê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ì‚¬ìš©ìë“¤ì´ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ëŠ” ìƒí™©ì…ë‹ˆë‹¤. ê°€ëŠ¥í•œ ë¹¨ë¦¬ í™•ì¸í•˜ê³  ì¡°ì¹˜í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.',
        recipient: 'ë°•ê³¼ì¥ë‹˜',
        date: new Date('2024-01-13T16:45:00'),
        score: 65,
        status: 'draft'
      },
      {
        user: testUser._id,
        type: 'review',
        title: 'ì—…ë¬´ í˜‘ì¡° ìš”ì²­',
        content: 'ì•ˆë…•í•˜ì„¸ìš”. í˜„ì¬ ë‹´ë‹¹í•˜ê³  ìˆëŠ” ì—…ë¬´ì—ì„œ ë„ì›€ì´ í•„ìš”í•˜ì—¬ ì—°ë½ë“œë¦½ë‹ˆë‹¤. ë°ì´í„° ë¶„ì„ ë¶€ë¶„ì—ì„œ ì „ë¬¸ì ì¸ ì¡°ì–¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ì‹œê°„ì´ ë˜ì‹¤ ë•Œ ì ê¹ ìƒë‹´í•  ìˆ˜ ìˆì„ê¹Œìš”?',
        recipient: 'ì´ëŒ€ë¦¬ë‹˜',
        date: new Date('2024-01-12T09:20:00'),
        score: 88,
        status: 'sent'
      },
      {
        user: testUser._id,
        type: 'manual',
        title: 'ëŠ¦ì€ ì‘ë‹µ ì‚¬ê³¼ ë©”ì¼',
        content: 'ì•ˆë…•í•˜ì„¸ìš”. ëŠ¦ì€ ë‹µë³€ìœ¼ë¡œ ì¸í•´ ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤. ë°”ìœ ì—…ë¬´ë¡œ ì¸í•´ ë‹µë³€ì´ ì§€ì—°ë˜ì—ˆìŠµë‹ˆë‹¤. ì•ìœ¼ë¡œëŠ” ë” ì‹ ì†í•˜ê²Œ ë‹µë³€í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.',
        recipient: 'ìµœë¶€ì¥ë‹˜',
        date: new Date('2024-01-11T13:55:00'),
        template: 'ëŠ¦ì€ ì‘ë‹µ ì‚¬ê³¼',
        status: 'sent'
      }
    ];

    // íˆìŠ¤í† ë¦¬ ë°ì´í„° ì‚½ì…
    await History.insertMany(initialHistory);
    
    console.log('âœ… History ì´ˆê¸° ë°ì´í„° ì‚½ì… ì™„ë£Œ');
  } catch (error) {
    console.error('âŒ History ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  }
};

module.exports = { initializeReplyGuides, initializeHistory }; 